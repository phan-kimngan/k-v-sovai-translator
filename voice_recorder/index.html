<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Voice Recorder Component</title>
</head>
<body>
  <button id="holdToTalk"
      style="
          width:100%;
          padding:16px;
          font-size:18px;
          border-radius:8px;
          background:#ff4b4b;
          color:white;">
      ğŸ¤ NHáº¤N & NHáº¤C TAY RA Äá»‚ Káº¾T THÃšC
  </button>
  <p id="status" style="font-size:14px;color:#444;"></p>

  <script>
    // ===================== STREAMLIT HANDSHAKE =====================
    const RENDER = "streamlit:render";
    const COMPONENT_READY = "streamlit:componentReady";
    const SET_COMPONENT_VALUE = "streamlit:setComponentValue";
    const SET_FRAME_HEIGHT = "streamlit:setFrameHeight";

    function sendMessage(type, data) {
      const msg = Object.assign({ isStreamlitMessage: true, type: type }, data);
      window.parent.postMessage(msg, "*");
    }

    // bÃ¡o cho Streamlit biáº¿t component Ä‘Ã£ sáºµn sÃ ng
    function notifyReady() {
      sendMessage(COMPONENT_READY, {});
      updateFrameHeight();
    }

    function updateFrameHeight() {
      const h = document.documentElement.clientHeight;
      sendMessage(SET_FRAME_HEIGHT, { height: h });
    }

    window.addEventListener("load", notifyReady);
    window.addEventListener("resize", updateFrameHeight);

    // nháº­n event RENDER tá»« Streamlit (khÃ´ng dÃ¹ng args nhÆ°ng váº«n nÃªn láº¯ng nghe)
    window.addEventListener("message", (event) => {
      if (event.data.type === RENDER) {
        updateFrameHeight();
      }
    });

    // ===================== VOICE RECORDER CODE =====================
    let mediaRecorder;
    let chunks = [];
    let recording = false;
    let startTime = 0;

    const MIN_TIME = 400;
    const btn = document.getElementById("holdToTalk");
    const statusBox = document.getElementById("status");

    // Touch (mobile)
    btn.addEventListener("touchstart", startRecording);
    btn.addEventListener("touchend", stopRecording);

    // Mouse (PC)
    btn.addEventListener("mousedown", startRecording);
    btn.addEventListener("mouseup", stopRecording);

    function startRecording(e) {
      if (recording) return;
      recording = true;
      chunks = [];
      startTime = Date.now();
      statusBox.innerHTML = "ğŸ™ï¸ Äang ghi Ã¢m...";

      navigator.mediaDevices.getUserMedia({ audio: true })
        .then(stream => {
          mediaRecorder = new MediaRecorder(stream);
          mediaRecorder.ondataavailable = e => chunks.push(e.data);
          mediaRecorder.start();
        })
        .catch(err => {
          console.error(err);
          statusBox.innerHTML = "â— KhÃ´ng truy cáº­p Ä‘Æ°á»£c micro";
          recording = false;
        });
    }

    function stopRecording(e) {
      if (!recording) return;

      let dt = Date.now() - startTime;
      if (dt < MIN_TIME) {
        statusBox.innerHTML = "â— Báº¡n pháº£i NHáº¤N & GIá»® > 0.4s Ä‘á»ƒ nÃ³i!";
        recording = false;
        return;
      }

      statusBox.innerHTML = "â³ Äang xá»­ lÃ½...";
      mediaRecorder.stop();
      recording = false;

      mediaRecorder.onstop = async () => {
        const blob = new Blob(chunks, { type: "audio/webm" });

        if (blob.size < 2000) {
          statusBox.innerHTML = "â— Ã‚m thanh quÃ¡ ngáº¯n hoáº·c khÃ´ng thu Ä‘Æ°á»£c!";
          return;
        }

        let formData = new FormData();
        formData.append("file", blob, "voice.webm");

        try {
          let r = await fetch("https://tenacious-von-occludent.ngrok-free.dev/voice2text", {
            method: "POST",
            body: formData,
            mode: "cors",
            headers: { "ngrok-skip-browser-warning": "1" }
          });

          let raw = await r.text();
          let res = JSON.parse(raw);

          statusBox.innerHTML = "âœ” OK: " + res.text;

          // ğŸ’¥ Gá»¬I TEXT Vá»€ PYTHON á» ÄÃ‚Y
          sendMessage(SET_COMPONENT_VALUE, { value: res.text });

        } catch (err) {
          console.error(err);
          statusBox.innerHTML = "â— Lá»—i khi gá»­i/nháº­n dá»¯ liá»‡u tá»« server";
        }
      };
    }
  </script>
</body>
</html>
